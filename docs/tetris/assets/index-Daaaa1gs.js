(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function e(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(i){if(i.ep)return;i.ep=!0;const o=e(i);fetch(i.href,o)}})();class k{id;components;constructor(t){this.id=t,this.components=new Map}addComponent(t,e){return this.components.set(t,e),this}getComponent(t){return this.components.get(t)}hasComponent(t){return this.components.has(t)}}class C{cells;pivot;baseHue;waveActive;waveStart;waveDuration;baseStagger;type;constructor(t){this.type=t,this.baseHue=t==="line"?120:t==="square"?0:t==="z"?60:t==="l"?280:t==="s"?30:t==="j"?200:40,this.cells=[],this.waveActive=!1,this.waveStart=0,this.waveDuration=260,this.baseStagger=22,this.pivot={x:150,y:15};let s=0;const i=90,o=210;if(t==="line"){for(let a=0;a<4;a++)for(let n=0;n<3;n++)for(let c=0;c<3;c++){const d=90+a*10*3+n*10,h=c*10,l=30+(d-i)/(o-i)*40,r=`hsl(${this.baseHue}, 80%, ${l}%)`;this.cells.push({x:d,y:h,shift:15,grounded:!1,row:null,startX:d,startY:h,targetX:d,targetY:h,width:10,height:10,color:r,lag:.18+(n+c+a)*.01,delay:s*this.baseStagger,index:s++})}this.pivot={x:150,y:15}}else if(t==="square"){for(let n=0;n<4;n++){const c=Math.floor(n/2),d=n%2;for(let h=0;h<3;h++)for(let y=0;y<3;y++){const l=90+d*10*3+h*10,r=c*10*3+y*10,f=30+(l-i)/(o-i)*40,g=`hsl(${this.baseHue}, 80%, ${f}%)`;this.cells.push({x:l,y:r,shift:0,grounded:!1,row:null,startX:l,startY:r,targetX:l,targetY:r,width:10,height:10,color:g,lag:.18+(h+y+n)*.01,delay:s*this.baseStagger,index:s++})}}this.pivot={x:60,y:60}}else if(t==="z"){let n=0;const c=[{col:0,row:0},{col:1,row:0},{col:1,row:1},{col:2,row:1}];for(let r=0;r<c.length;r++){const{col:w,row:f}=c[r];for(let g=0;g<3;g++)for(let m=0;m<3;m++){const p=90+w*10*3+g*10,v=f*10*3+m*10,S=30+(p-i)/(o-i)*40,b=`hsl(${this.baseHue}, 80%, ${S}%)`;this.cells.push({x:p,y:v,shift:15,grounded:!1,row:null,startX:p,startY:v,targetX:p,targetY:v,width:10,height:10,color:b,lag:.18+(g+m+r)*.01,delay:n*this.baseStagger,index:n++})}}const d=Math.min(...this.cells.map(r=>r.targetX)),h=Math.max(...this.cells.map(r=>r.targetX+r.width)),y=Math.min(...this.cells.map(r=>r.targetY)),l=Math.max(...this.cells.map(r=>r.targetY+r.height));this.pivot={x:(d+h)/2,y:(y+l)/2}}else if(t==="l"){let n=0;const c=[{col:0,row:0},{col:0,row:1},{col:0,row:2},{col:1,row:2}];for(let r=0;r<c.length;r++){const{col:w,row:f}=c[r];for(let g=0;g<3;g++)for(let m=0;m<3;m++){const p=90+w*10*3+g*10,v=f*10*3+m*10,S=30+(p-i)/(o-i)*40,b=`hsl(${this.baseHue}, 80%, ${S}%)`;this.cells.push({x:p,y:v,shift:15,grounded:!1,row:null,startX:p,startY:v,targetX:p,targetY:v,width:10,height:10,color:b,lag:.18+(g+m+r)*.01,delay:n*this.baseStagger,index:n++})}}const d=Math.min(...this.cells.map(r=>r.targetX)),h=Math.max(...this.cells.map(r=>r.targetX+r.width)),y=Math.min(...this.cells.map(r=>r.targetY)),l=Math.max(...this.cells.map(r=>r.targetY+r.height));this.pivot={x:(d+h)/2,y:(y+l)/2}}else if(t==="s"){const a=[{col:1,row:0},{col:2,row:0},{col:0,row:1},{col:1,row:1}];let n=0;for(let l=0;l<a.length;l++){const{col:r,row:w}=a[l];for(let f=0;f<3;f++)for(let g=0;g<3;g++){const m=90+r*10*3+f*10,p=w*10*3+g*10,v=30+(m-i)/(o-i)*40,S=`hsl(${this.baseHue}, 80%, ${v}%)`;this.cells.push({x:m,y:p,shift:15,grounded:!1,row:null,startX:m,startY:p,targetX:m,targetY:p,width:10,height:10,color:S,lag:.18+(f+g+l)*.01,delay:n*this.baseStagger,index:n++})}}const c=Math.min(...this.cells.map(l=>l.targetX)),d=Math.max(...this.cells.map(l=>l.targetX+l.width)),h=Math.min(...this.cells.map(l=>l.targetY)),y=Math.max(...this.cells.map(l=>l.targetY+l.height));this.pivot={x:(c+d)/2,y:(h+y)/2}}else if(t==="j"){const a=[{col:1,row:0},{col:1,row:1},{col:1,row:2},{col:0,row:2}];let n=0;for(let l=0;l<a.length;l++){const{col:r,row:w}=a[l];for(let f=0;f<3;f++)for(let g=0;g<3;g++){const m=90+r*10*3+f*10,p=w*10*3+g*10,v=30+(m-i)/(o-i)*40,S=`hsl(${this.baseHue}, 80%, ${v}%)`;this.cells.push({x:m,y:p,shift:15,grounded:!1,row:null,startX:m,startY:p,targetX:m,targetY:p,width:10,height:10,color:S,lag:.18+(f+g+l)*.01,delay:n*this.baseStagger,index:n++})}}const c=Math.min(...this.cells.map(l=>l.targetX)),d=Math.max(...this.cells.map(l=>l.targetX+l.width)),h=Math.min(...this.cells.map(l=>l.targetY)),y=Math.max(...this.cells.map(l=>l.targetY+l.height));this.pivot={x:(c+d)/2,y:(h+y)/2}}}}class X{grid;raf;weight;velocity;timeStep;accumulated;current;soundOn;fallSmooth;score;lastBgAnimation;constructor(){this.grid=[],this.raf=null,this.weight=1,this.velocity=30,this.timeStep=1e3/60,this.accumulated=0,this.current=0,this.soundOn=!0,this.fallSmooth=.18,this.score=0,this.lastBgAnimation=0}}function Y(u){const t=new k(u),e=new X;return t.addComponent("game",e),t}function z(u,t){const e=new k(u),s=new C(t);return e.addComponent("tetromino",s),e}class B{groundCollision(t,e){return t.some(s=>s.targetY+s.height>=e.height)}wallCollision(t,e,s){return t.some(i=>s==="left"?i.targetX<=0:i.targetX+i.width>=e.width)}blockCollision(t,e,s){for(const i of t){const o=i.targetY+s;for(const a of e){const n=i.targetX<a.x+a.width&&i.targetX+i.width>a.x,c=o+i.height>a.y&&i.targetY<a.y;if(n&&c)return!0}}return!1}horizontalBlockCollision(t,e,s,i){for(const o of t){const a=s==="left"?o.targetX-i:o.targetX+i;for(const n of e)if(o.targetY<n.y+n.height&&o.targetY+o.height>n.y){if(s==="left"){if(a<n.x+n.width&&o.targetX+o.width>n.x+n.width)return!0}else if(a+o.width>n.x&&o.targetX<n.x)return!0}}return!1}}class M{game;eventBus;constructor(t,e){this.game=t.getComponent("game"),this.eventBus=e}checkGameOver(){if(this.game.grid.some(s=>s.row!==null&&s.row<2)){this.game.soundOn&&this.eventBus.emit("gameover"),this.game.raf&&cancelAnimationFrame(this.game.raf),this.game.raf=null;const s=document.getElementById("gameover-overlay");return s&&(s.style.display="flex"),!0}return!1}setGrounded(t){this.game.soundOn&&this.eventBus.emit("point");const e=t.cells[0].width;for(const s of t.cells){const i=Math.round(s.targetX/e)*e,o=Math.round(s.targetY/e)*e;s.targetX=i,s.targetY=o,s.x=i,s.y=o,s.grounded=!0,s.row=o/e,this.game.grid.push({...s})}}addScore(t){this.game.soundOn&&this.eventBus.emit("explosion");const e=document.getElementById("score");if(!e)return;const s=this.game.score,i=s+t;let o=s;const a=()=>{if(o<i){o++,e.innerText=o.toString();const n=document.createElement("span");n.className="score-flash",n.innerText="+1",e.appendChild(n);const c=(Math.random()-.5)*20,d=-20-Math.random()*10;n.style.transform=`translate(${c}px, ${d}px) scale(1)`,n.style.opacity="1",setTimeout(()=>{n.style.transform=`translate(${c}px, ${d-10}px) scale(1.5)`,n.style.opacity="0"},20),setTimeout(()=>n.remove(),400),requestAnimationFrame(a)}};a(),this.game.score=i}clearFullLines(t,e){const s=t.cells[0].width,i=e.width/s;let o=0;for(;o*s<e.height;){if(this.game.grid.filter(n=>n.row===o&&n.grounded).length>=i){this.game.grid=this.game.grid.filter(n=>n.row!==o),this.addScore(10);for(const n of this.game.grid)if(n.row!==null&&n.row<o)if(n.row+=1,n.targetY+=s,typeof n.startWave=="function")n.startWave();else{const c=n.y,d=n.targetY;let h=0;const y=()=>{h+=.2,n.y=c+(d-c)*(1-Math.cos(h))/2,h<Math.PI?requestAnimationFrame(y):n.y=d};y()}continue}o++}}setBackground(){const t=document.getElementById("app"),e=document.createElement("div");e.setAttribute("id","bg");for(let s=0;s<1600;s++){const i=document.createElement("div");i.setAttribute("class","cell"),e.appendChild(i)}t&&t.appendChild(e)}animateBackground(){const t=document.getElementById("bg");if(!t)return;const e=Array.from(t.children);e.filter(a=>a.classList.contains("scale-cell")).forEach(a=>a.classList.remove("scale-cell"));const i=e.filter(a=>!a.classList.contains("scale-cell")),o=Math.min(200,i.length);for(let a=0;a<o;a++){const n=Math.floor(Math.random()*i.length);i[n].classList.add("scale-cell"),i.splice(n,1)}}settingsUi(t){const e=document.createElement("div");e.setAttribute("class","score-wrap");const s=document.createElement("div");s.setAttribute("class","score-block");const i=document.createElement("div");i.setAttribute("class","score-label"),i.innerText="Score:";const o=document.createElement("div");o.setAttribute("id","score"),o.innerText="0",s.appendChild(i),s.appendChild(o);const a=document.createElement("div");a.setAttribute("class","buttons-block");const n=document.createElement("button"),c=document.createElement("div"),d=document.createElement("div");c.setAttribute("class","block1"),d.setAttribute("class","block2"),n.setAttribute("class","control-btn"),n.appendChild(c),n.appendChild(d),n.onclick=()=>{if(this.game.soundOn&&this.eventBus.emit("gamestart"),this.game.raf){cancelAnimationFrame(this.game.raf),this.game.raf=null,d.classList.add("scale-b-2");let v=setTimeout(()=>{c.classList.add("scale-b-1"),d.style.display="none",clearTimeout(v)},500)}else{this.game.current=performance.now(),this.game.raf=requestAnimationFrame(t),c.classList.remove("scale-b-1"),d.style.display="block";let v=setTimeout(()=>{d.classList.remove("scale-b-2"),clearTimeout(v)},500)}};const h=document.createElement("button"),y=document.createElement("span"),l=document.createElement("span"),r=document.createElement("span"),w=document.createElement("span");y.setAttribute("class","sound"),l.setAttribute("class","wave1"),r.setAttribute("class","wave2"),w.setAttribute("class","wave3"),h.setAttribute("class","control-btn"),h.appendChild(y),h.appendChild(l),h.appendChild(r),h.appendChild(w),h.onclick=()=>{this.game.soundOn&&this.eventBus.emit("gamestart"),this.game.soundOn=!this.game.soundOn,this.game.soundOn?(l.classList.add("fade-in-sound"),l.classList.remove("fade-out-sound"),r.classList.add("fade-in-sound"),r.classList.remove("fade-out-sound"),w.classList.add("fade-in-sound"),w.classList.remove("fade-out-sound")):(l.classList.add("fade-out-sound"),l.classList.remove("fade-in-sound"),r.classList.add("fade-out-sound"),r.classList.remove("fade-in-sound"),w.classList.add("fade-out-sound"),w.classList.remove("fade-in-sound"))},a.appendChild(n),a.appendChild(h),e.appendChild(s),e.appendChild(a),document.body.appendChild(e);const f=document.createElement("div");f.id="start-overlay",f.className="overlay",f.innerHTML='<h1 class="fade-in">Tetris</h1><button class="fade-in delay" id="start-btn">Start</button>',document.body.appendChild(f),f.style.display="flex";const g=document.getElementById("start-btn");g.onclick=()=>{this.game.soundOn&&this.eventBus.emit("gamestart"),f.style.display="none",this.game.current=performance.now(),this.game.raf=requestAnimationFrame(t)};const m=document.createElement("div");m.id="gameover-overlay",m.className="overlay",m.innerHTML='<h1 class="fade-in">Game Over</h1><button class="fade-in delay" id="restart-btn">Restart</button>',document.body.appendChild(m),m.style.display="none";const p=document.getElementById("restart-btn");p.onclick=()=>{this.game.soundOn&&this.eventBus.emit("gamestart"),document.getElementById("score").innerText="0",m.style.display="none",this.game.grid=[],this.game.current=performance.now(),this.game.raf=requestAnimationFrame(t)}}}function x(u,t,e){return u+(t-u)*e}function A(u){return 1-Math.pow(1-u,3)}class E{update(t,e,s){for(const i of t){const o=i.getComponent("tetromino");o&&(this.findPivot(o),this.fallBy(e,s,o),this.updatePositions(performance.now(),.18,o))}}rotate(t,e,s){const i=t.targetX+t.width/2,o=t.targetY+t.height/2,a=i-s.x,n=o-s.y;let c,d;e==="left"?(c=-n,d=a):(c=n,d=-a);const h=s.x+c,y=s.y+d;t.targetX=h-t.width/2,t.targetY=y-t.height/2,e==="left"?t.targetX-=t.shift:t.targetX+=t.shift}fallBy(t,e,s){const i=Math.max(...s.cells.map(o=>o.targetY+o.height));if(i+e>t.height){const o=t.height-i;for(let a of s.cells)a.targetY+=o;return!1}for(let o of s.cells)o.targetY+=e;return!0}findPivot(t){const e=Math.min(...t.cells.map(a=>a.targetX)),s=Math.max(...t.cells.map(a=>a.targetX+a.width)),i=Math.min(...t.cells.map(a=>a.targetY)),o=Math.max(...t.cells.map(a=>a.targetY+a.height));t.pivot.x=(e+s)/2,t.pivot.y=(i+o)/2}startWave(t=150,e){e.waveActive=!0,e.waveStart=performance.now(),e.waveDuration=t;for(let s of e.cells)s.startX=s.x,s.startY=s.y}updatePositions(t,e=.18,s){if(s.waveActive){let i=!0;for(let o of s.cells){const a=Math.max(0,t-s.waveStart-o.delay),n=Math.min(1,a/s.waveDuration),c=A(n);o.x=x(o.startX,o.targetX,c),o.y=x(o.startY,o.targetY,c),n<1&&(i=!1)}if(i){s.waveActive=!1;for(let o of s.cells)o.x=o.targetX,o.y=o.targetY}}else for(let i of s.cells)i.x=i.targetX,i.y+=(i.targetY-i.y)*e}moveHorizontalBy(t,e,s){const i=Math.min(...s.cells.map(a=>a.targetX)),o=Math.max(...s.cells.map(a=>a.targetX+a.width));if(i+t<0||o+t>e.width)return!1;for(let a of s.cells)a.targetX+=t;return!0}}class L{ctx;constructor(t){this.ctx=t}render(t,e){for(const s of t){const i=s.getComponent("tetromino");if(i){for(let o of i.cells)this.ctx.fillStyle=o.color,this.ctx.fillRect(o.x,o.y,o.width,o.height);continue}}for(const s of e)this.ctx.fillStyle=s.color??"#ccc",this.ctx.fillRect(s.x,s.y,s.width,s.height)}}class O{keysPressed={};keysJustPressed={};constructor(){window.addEventListener("keydown",t=>this.onKeyDown(t)),window.addEventListener("keyup",t=>this.onKeyUp(t))}onKeyDown(t){this.keysPressed[t.code]||(this.keysJustPressed[t.code]=!0),this.keysPressed[t.code]=!0}onKeyUp(t){this.keysPressed[t.code]=!1,this.keysJustPressed[t.code]=!1}isPressed(t){return!!this.keysPressed[t]}wasJustPressed(t){return this.keysJustPressed[t]?(this.keysJustPressed[t]=!1,!0):!1}}class P{listeners={};on(t,e){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(e)}off(t,e){e?this.listeners[t]&&(this.listeners[t]=this.listeners[t].filter(s=>s!==e)):delete this.listeners[t]}emit(t,...e){if(this.listeners[t])for(const s of this.listeners[t])s(...e)}}class T{canvas;ctx;tetromino;gameState;controls;entityIdCounter=1;renderSystem;physicsSystem;collisionSystem;gameStateSystem;eventBus;constructor(t,e){this.tetromino=null,this.canvas=t,this.ctx=e,this.eventBus=new P,this.collisionSystem=new B,this.controls=new O,this.renderSystem=new L(this.ctx),this.physicsSystem=new E,this.gameState=Y(this.entityIdCounter++),this.gameStateSystem=new M(this.gameState,this.eventBus),this.randomizer()}loop=t=>{const e=this.gameState.getComponent("game");if(e){let s=!1;const i=t-e.current;for(e.accumulated+=i,e.current=t,e.accumulated>1e3&&(e.accumulated=e.timeStep);e.accumulated>=e.timeStep;)this.update(),e.accumulated-=e.timeStep,s=!0,e.lastBgAnimation+=e.timeStep,e.lastBgAnimation>5e3&&(this.gameStateSystem.animateBackground(),e.lastBgAnimation=0);s&&this.render(),e.raf&&(e.raf=window.requestAnimationFrame(this.loop))}};update=()=>{if(!this.tetromino)return;const t=this.tetromino.getComponent("tetromino"),e=this.gameState.getComponent("game");if(t&&e){e.weight=this.controls.isPressed("ArrowDown")?3:1;const s=e.weight;this.physicsSystem.findPivot(t);const i=this.collisionSystem.groundCollision(t.cells,this.canvas),o=this.collisionSystem.blockCollision(t.cells,e.grid,s);if(i||o){if(this.gameStateSystem.setGrounded(t),this.gameStateSystem.clearFullLines(t,this.canvas),this.gameStateSystem.checkGameOver())return;this.randomizer();return}if(this.controls.wasJustPressed("ArrowLeft")&&(e.soundOn&&this.eventBus.emit("rotate"),!this.collisionSystem.wallCollision(t.cells,this.canvas,"left")&&!this.collisionSystem.horizontalBlockCollision(t.cells,e.grid,"left",s)&&(this.physicsSystem.moveHorizontalBy(-e.velocity,this.canvas,t),this.physicsSystem.startWave(150,t))),this.controls.wasJustPressed("ArrowRight")&&(e.soundOn&&this.eventBus.emit("rotate"),!this.collisionSystem.wallCollision(t.cells,this.canvas,"right")&&!this.collisionSystem.horizontalBlockCollision(t.cells,e.grid,"right",s)&&(this.physicsSystem.moveHorizontalBy(e.velocity,this.canvas,t),this.physicsSystem.startWave(150,t))),this.controls.wasJustPressed("KeyA")||this.controls.wasJustPressed("KeyD")){e.soundOn&&this.eventBus.emit("rotate");const a=this.controls.wasJustPressed("KeyA")?"left":"right",n=t.cells.some(h=>h.targetX<0||h.targetX+h.width>this.canvas.width),c=t.cells.some(h=>h.targetY+h.height>this.canvas.height),d=this.collisionSystem.blockCollision(t.cells,e.grid,0);if(!n&&!c&&!d){for(let h of t.cells)this.physicsSystem.rotate(h,a,t.pivot);this.physicsSystem.startWave(150,t)}}for(let a of t.cells)a.targetX>this.canvas.width&&(this.physicsSystem.moveHorizontalBy(-e.velocity,this.canvas,t),this.physicsSystem.startWave(150,t)),a.targetX<0&&(this.physicsSystem.moveHorizontalBy(e.velocity,this.canvas,t),this.physicsSystem.startWave(150,t));this.physicsSystem.update([this.tetromino],this.canvas,s)}};render=()=>{const t=this.gameState.getComponent("game");t&&this.tetromino&&(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.renderSystem.render([this.tetromino],t.grid))};randomizer=()=>{const t=["line","square","z","l","s","j"],e=Math.round(Math.random()*5),s=t[e];this.tetromino=z(this.entityIdCounter++,s)};start(){this.randomizer(),this.gameStateSystem.settingsUi(this.loop),this.gameStateSystem.setBackground()}}document.querySelector("#app").innerHTML=`
  <div>
    <canvas id="canvas" />
  </div>
`;window.addEventListener("DOMContentLoaded",()=>{const u=document.getElementById("canvas"),t=u.getContext("2d",{alpha:!0});u.width=300,u.height=660,new T(u,t).start()});
