(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function e(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(n){if(n.ep)return;n.ep=!0;const o=e(n);fetch(n.href,o)}})();class p{keysPressed={};keysJustPressed={};constructor(){window.addEventListener("keydown",t=>this.onKeyDown(t)),window.addEventListener("keyup",t=>this.onKeyUp(t))}onKeyDown(t){this.keysPressed[t.code]||(this.keysJustPressed[t.code]=!0),this.keysPressed[t.code]=!0}onKeyUp(t){this.keysPressed[t.code]=!1,this.keysJustPressed[t.code]=!1}isPressed(t){return!!this.keysPressed[t]}wasJustPressed(t){return this.keysJustPressed[t]?(this.keysJustPressed[t]=!1,!0):!1}}class g{id;components;constructor(t){this.id=t,this.components=new Map}addComponent(t,e){return this.components.set(t,e),this}getComponent(t){return this.components.get(t)}hasComponent(t){return this.components.has(t)}}class w{cells;pivot;baseHue;waveActive;waveStart;waveDuration;baseStagger;constructor(){this.baseHue=Math.floor(Math.random()*360),this.cells=[],this.waveActive=!1,this.waveStart=0,this.waveDuration=260,this.baseStagger=22;let e=0;for(let s=0;s<4;s++)for(let n=0;n<3;n++)for(let o=0;o<3;o++){const i=90+s*10*3+n*10,r=o*10;this.cells.push({x:i,y:r,shift:15,grounded:!1,row:null,startX:i,startY:r,targetX:i,targetY:r,width:10,height:10,color:"blue",lag:.18+(n+o+s)*.01,delay:e*this.baseStagger,index:e++})}this.pivot={x:150,y:15}}}class v{type;constructor(t){this.type=t}}class S{grid;raf;weight;velocity;timeStep;accumulated;current;soundOn;fallSmooth;score;constructor(){this.grid=[],this.raf=null,this.weight=1,this.velocity=30,this.timeStep=1e3/60,this.accumulated=0,this.current=0,this.soundOn=!0,this.fallSmooth=.18,this.score=0}}function x(c){const t=new g(c),e=new S;return t.addComponent("game",e),t}function u(c,t){const e=new g(c),s=new w,n=new v(t);return e.addComponent("tetromino",s).addComponent("type",n),e}class C{ctx;constructor(t){this.ctx=t}render(t,e){for(const s of t){const n=s.getComponent("type"),o=s.getComponent("tetromino");if(o&&n&&n.type==="line"){const i=Math.min(...o.cells.map(a=>a.x)),r=Math.max(...o.cells.map(a=>a.x+a.width));for(let a of o.cells){const h=(a.x-i)/(r-i||1),m=`hsl(${(o.baseHue+h*60)%360}, 80%, 50%)`;a.color=m,this.ctx.fillStyle=m,this.ctx.fillRect(a.x,a.y,a.width,a.height)}continue}}for(const s of e)this.ctx.fillStyle=s.color??"#ccc",this.ctx.fillRect(s.x,s.y,s.width,s.height)}}function f(c,t,e){return c+(t-c)*e}function b(c){return 1-Math.pow(1-c,3)}class X{update(t,e,s){for(const n of t){const o=n.getComponent("tetromino");o&&(this.findPivot(o),this.fallBy(e,s,o),this.updatePositions(performance.now(),.18,o))}}rotate(t,e,s){const n=t.targetX+t.width/2,o=t.targetY+t.height/2,i=n-s.x,r=o-s.y;let a,h;e==="left"?(a=-r,h=i):(a=r,h=-i);const l=s.x+a,m=s.y+h;t.targetX=l-t.width/2,t.targetY=m-t.height/2,e==="left"?t.targetX-=t.shift:t.targetX+=t.shift}fallBy(t,e,s){const n=Math.max(...s.cells.map(o=>o.targetY+o.height));if(n+e>t.height){const o=t.height-n;for(let i of s.cells)i.targetY+=o;return!1}for(let o of s.cells)o.targetY+=e;return!0}findPivot(t){const e=Math.min(...t.cells.map(i=>i.targetX)),s=Math.max(...t.cells.map(i=>i.targetX+i.width)),n=Math.min(...t.cells.map(i=>i.targetY)),o=Math.max(...t.cells.map(i=>i.targetY+i.height));t.pivot.x=(e+s)/2,t.pivot.y=(n+o)/2}startWave(t=150,e){e.waveActive=!0,e.waveStart=performance.now(),e.waveDuration=t;for(let s of e.cells)s.startX=s.x,s.startY=s.y}updatePositions(t,e=.18,s){if(s.waveActive){let n=!0;for(let o of s.cells){const i=Math.max(0,t-s.waveStart-o.delay),r=Math.min(1,i/s.waveDuration),a=b(r);o.x=f(o.startX,o.targetX,a),o.y=f(o.startY,o.targetY,a),r<1&&(n=!1)}if(n){s.waveActive=!1;for(let o of s.cells)o.x=o.targetX,o.y=o.targetY}}else for(let n of s.cells)n.x=n.targetX,n.y+=(n.targetY-n.y)*e}moveHorizontalBy(t,e,s){const n=Math.min(...s.cells.map(i=>i.targetX)),o=Math.max(...s.cells.map(i=>i.targetX+i.width));if(n+t<0||o+t>e.width)return!1;for(let i of s.cells)i.targetX+=t;return!0}}class Y{groundCollision(t,e){return t.some(s=>s.targetY+s.height>=e.height)}wallCollision(t,e,s){return t.some(n=>s==="left"?n.targetX<=0:n.targetX+n.width>=e.width)}blockCollision(t,e,s){for(const n of t){const o=n.targetY+s;for(const i of e){const r=n.targetX<i.x+i.width&&n.targetX+n.width>i.x,a=o+n.height>i.y&&n.targetY<i.y;if(r&&a)return!0}}return!1}horizontalBlockCollision(t,e,s,n){for(const o of t){const i=s==="left"?o.targetX-n:o.targetX+n;for(const r of e)if(o.targetY<r.y+r.height&&o.targetY+o.height>r.y){if(s==="left"){if(i<r.x+r.width&&o.targetX+o.width>r.x+r.width)return!0}else if(i+o.width>r.x&&o.targetX<r.x)return!0}}return!1}}class k{game;constructor(t){this.game=t.getComponent("game")}checkGameOver(){if(this.game.grid.some(s=>s.row!==null&&s.row<2)){this.game.raf&&cancelAnimationFrame(this.game.raf),this.game.raf=null;const s=document.getElementById("gameover-overlay");return s&&(s.style.display="flex"),!0}return!1}setGrounded(t){const e=t.cells[0].width;for(const s of t.cells){const n=Math.round(s.targetX/e)*e,o=Math.round(s.targetY/e)*e;s.targetX=n,s.targetY=o,s.x=n,s.y=o,s.grounded=!0,s.row=o/e,this.game.grid.push({...s})}}addScore(t){const e=document.getElementById("score");if(!e)return;const s=this.game.score,n=s+t;let o=s;const i=()=>{if(o<n){o++,e.innerText=o.toString();const r=document.createElement("span");r.className="score-flash",r.innerText="+1",e.appendChild(r);const a=(Math.random()-.5)*20,h=-20-Math.random()*10;r.style.transform=`translate(${a}px, ${h}px) scale(1)`,r.style.opacity="1",setTimeout(()=>{r.style.transform=`translate(${a}px, ${h-10}px) scale(1.5)`,r.style.opacity="0"},20),setTimeout(()=>r.remove(),400),requestAnimationFrame(i)}};i(),this.game.score=n}clearFullLines(t,e){const s=t.cells[0].width,n=e.width/s;let o=0;for(;o*s<e.height;){if(this.game.grid.filter(r=>r.row===o&&r.grounded).length>=n){this.game.grid=this.game.grid.filter(r=>r.row!==o),this.addScore(10);for(const r of this.game.grid)if(r.row!==null&&r.row<o)if(r.row+=1,r.targetY+=s,typeof r.startWave=="function")r.startWave();else{const a=r.y,h=r.targetY;let l=0;const m=()=>{l+=.2,r.y=a+(h-a)*(1-Math.cos(l))/2,l<Math.PI?requestAnimationFrame(m):r.y=h};m()}continue}o++}}}class A{canvas;ctx;tetromino;gameState;controls;entityIdCounter=1;renderSystem;physicsSystem;collisionSystem;gameStateSystem;constructor(t,e){this.canvas=t,this.ctx=e,this.collisionSystem=new Y,this.controls=new p,this.renderSystem=new C(this.ctx),this.physicsSystem=new X,this.tetromino=u(this.entityIdCounter++,"line"),this.gameState=x(this.entityIdCounter++),this.gameStateSystem=new k(this.gameState)}loop=t=>{const e=this.gameState.getComponent("game");if(e){let s=!1;const n=t-e.current;for(e.accumulated+=n,e.current=t,e.accumulated>1e3&&(e.accumulated=e.timeStep);e.accumulated>=e.timeStep;)this.update(),e.accumulated-=e.timeStep,s=!0;s&&this.render(),e.raf&&(e.raf=window.requestAnimationFrame(this.loop))}};update=()=>{const t=this.tetromino.getComponent("tetromino"),e=this.gameState.getComponent("game");if(t&&e){e.weight=this.controls.isPressed("ArrowDown")?3:1;const s=e.weight;this.physicsSystem.findPivot(t);const n=this.collisionSystem.groundCollision(t.cells,this.canvas),o=this.collisionSystem.blockCollision(t.cells,e.grid,s);if(n||o){if(this.gameStateSystem.setGrounded(t),this.gameStateSystem.clearFullLines(t,this.canvas),this.gameStateSystem.checkGameOver())return;this.tetromino=u(this.entityIdCounter++,"line");return}if(this.controls.wasJustPressed("ArrowLeft")&&!this.collisionSystem.wallCollision(t.cells,this.canvas,"left")&&!this.collisionSystem.horizontalBlockCollision(t.cells,e.grid,"left",s)&&(this.physicsSystem.moveHorizontalBy(-e.velocity,this.canvas,t),this.physicsSystem.startWave(150,t)),this.controls.wasJustPressed("ArrowRight")&&!this.collisionSystem.wallCollision(t.cells,this.canvas,"right")&&!this.collisionSystem.horizontalBlockCollision(t.cells,e.grid,"right",s)&&(this.physicsSystem.moveHorizontalBy(e.velocity,this.canvas,t),this.physicsSystem.startWave(150,t)),this.controls.wasJustPressed("KeyA")||this.controls.wasJustPressed("KeyD")){const i=this.controls.wasJustPressed("KeyA")?"left":"right",r=t.cells.some(l=>l.targetX<0||l.targetX+l.width>this.canvas.width),a=t.cells.some(l=>l.targetY+l.height>this.canvas.height),h=this.collisionSystem.blockCollision(t.cells,e.grid,0);if(!r&&!a&&!h){for(let l of t.cells)this.physicsSystem.rotate(l,i,t.pivot);this.physicsSystem.startWave(150,t)}}for(let i of t.cells)i.targetX>this.canvas.width&&(this.physicsSystem.moveHorizontalBy(-e.velocity,this.canvas,t),this.physicsSystem.startWave(150,t)),i.targetX<0&&(this.physicsSystem.moveHorizontalBy(e.velocity,this.canvas,t),this.physicsSystem.startWave(150,t));this.physicsSystem.update([this.tetromino],this.canvas,s)}};render=()=>{const t=this.gameState.getComponent("game");t&&(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.renderSystem.render([this.tetromino],t.grid))};start(){this.settingsUi()}startGame(){const t=this.gameState.getComponent("game");if(t){t.grid=[],this.tetromino=u(this.entityIdCounter++,"line"),t.current=performance.now(),t.raf&&cancelAnimationFrame(t.raf),t.raf=requestAnimationFrame(this.loop);const e=document.getElementById("score");e&&(e.innerText="0");const s=document.getElementById("start-overlay");s&&(s.style.display="none");const n=document.getElementById("gameover-overlay");n&&(n.style.display="none")}}togglePause(t){const e=this.gameState.getComponent("game");e&&(e.raf?(cancelAnimationFrame(e.raf),e.raf=null,t.innerText="▶"):(e.current=performance.now(),e.raf=requestAnimationFrame(this.loop),t.innerText="⏸"))}settingsUi(){const t=this.gameState.getComponent("game");if(t){const e=document.createElement("div");e.setAttribute("class","score-wrap");const s=document.createElement("div");s.setAttribute("class","score-block");const n=document.createElement("div");n.setAttribute("class","score-label"),n.innerText="Score:";const o=document.createElement("div");o.setAttribute("id","score"),o.innerText="0",s.appendChild(n),s.appendChild(o);const i=document.createElement("div");i.setAttribute("class","buttons-block");const r=document.createElement("button");r.setAttribute("class","control-btn pause-btn"),r.innerText="⏸",r.onclick=()=>{t.raf?(cancelAnimationFrame(t.raf),t.raf=null,r.innerText="▶"):(t.current=performance.now(),t.raf=requestAnimationFrame(this.loop),r.innerText="⏸")};const a=document.createElement("button");a.setAttribute("class","control-btn sound-btn"),a.innerText="🔊";let h=!0;a.onclick=()=>{h=!h,a.innerText=h?"🔊":"🔇"},i.appendChild(r),i.appendChild(a),e.appendChild(s),e.appendChild(i),document.body.appendChild(e);const l=document.createElement("div");l.id="start-overlay",l.className="overlay",l.innerHTML='<h1>Tetris</h1><button id="start-btn">Start</button>',document.body.appendChild(l),l.style.display="flex";const m=document.getElementById("start-btn");m.onclick=()=>{l.style.display="none",t.current=performance.now(),t.raf=requestAnimationFrame(this.loop)};const d=document.createElement("div");d.id="gameover-overlay",d.className="overlay",d.innerHTML='<h1>Game Over</h1><button id="restart-btn">Restart</button>',document.body.appendChild(d),d.style.display="none";const y=document.getElementById("restart-btn");y.onclick=()=>{d.style.display="none",t.grid=[],this.tetromino=u(this.entityIdCounter++,"line"),document.getElementById("score").innerText="0",t.current=performance.now(),t.raf=requestAnimationFrame(this.loop)}}}}document.querySelector("#app").innerHTML=`
  <div>
    <canvas id="canvas" />
  </div>
`;window.addEventListener("DOMContentLoaded",()=>{const c=document.getElementById("canvas"),t=c.getContext("2d",{alpha:!1});c.width=300,c.height=660,new A(c,t).start()});
